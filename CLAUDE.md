# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

Before starting development, Read './docs/tasks.md' and when you complete the task, check the task by writing 'x'.

## Project Overview

This is a full-stack React application built with React Router v7 and deployed on Cloudflare Pages. The application uses server-side rendering (SSR) and is configured to run on Cloudflare Workers runtime.

## Technology Stack

- **Framework**: React Router v7 with SSR enabled
- **Runtime**: Cloudflare Workers (workerd)
- **UI**: React 19 with TailwindCSS v4
- **Build Tool**: Vite 7
- **Package Manager**: Bun (as indicated by bun.lock)
- **TypeScript**: Strict mode enabled

## Development Commands

### Starting Development
```bash
bun run dev
# Or: npm run dev
# Starts dev server at http://localhost:5173
```

### Type Checking
```bash
bun run typecheck
# Runs: cf-typegen -> react-router typegen -> tsc -b
# Always run this before committing
```

### Building
```bash
bun run build
# Production build using react-router build
```

### Preview Production Build
```bash
bun run preview
# Builds and previews production build locally
```

### Deployment
```bash
bun run deploy
# Builds and deploys to Cloudflare
```

For preview deployments:
```bash
npx wrangler versions upload
npx wrangler versions deploy  # Promote after verification
```

### Generate Cloudflare Types
```bash
bun run cf-typegen
# Runs automatically after install via postinstall hook
# Generates worker-configuration.d.ts from workers/app.ts
```

## Architecture

### Directory Structure

- **`app/`** - React Router application code
  - `root.tsx` - Root layout with error boundary
  - `routes.ts` - Route configuration (uses flat file routing)
  - `routes/` - Route modules
  - `+types/` - Auto-generated route types (via React Router typegen)
  - `welcome/` - Welcome component with assets
  - `entry.server.tsx` - SSR entry point with bot detection
  - `app.css` - Global styles (Tailwind directives)

- **`workers/`** - Cloudflare Workers configuration
  - `app.ts` - Worker entry point, creates request handler and exports fetch handler

- **`public/`** - Static assets

### TypeScript Configuration

The project uses TypeScript project references with three configs:
- `tsconfig.json` - Root config (references only)
- `tsconfig.node.json` - For Node.js tooling (vite.config.ts)
- `tsconfig.cloudflare.json` - For app code and workers

**Important**: The `worker-configuration.d.ts` file is auto-generated by `wrangler types`. Never edit it manually.

### Cloudflare Integration

**Workers Entry Point** (`workers/app.ts`):
- Exports a fetch handler that wraps the React Router request handler
- Augments `AppLoadContext` with `cloudflare.env` and `cloudflare.ctx`
- Env vars are accessed via `context.cloudflare.env` in loaders/actions

**Example** (from `app/routes/home.tsx`):
```typescript
export function loader({ context }: Route.LoaderArgs) {
  return { message: context.cloudflare.env.VALUE_FROM_CLOUDFLARE };
}
```

### Routing System

Routes are configured in `app/routes.ts` using React Router's flat file config:
```typescript
export default [index("routes/home.tsx")] satisfies RouteConfig;
```

Each route module can export:
- `loader` - Server-side data loading
- `action` - Server-side mutations
- `meta` - SEO metadata
- `default` - Component
- Type-safe args via `Route.LoaderArgs`, `Route.ComponentProps`, etc.

### SSR & Hydration

**Server Entry** (`app/entry.server.tsx`):
- Uses `renderToReadableStream` for streaming SSR
- Waits for full render for bots (via `isbot` package)
- Custom error handling during shell rendering

**Root Layout** (`app/root.tsx`):
- Wraps all routes with HTML boilerplate
- Includes global error boundary
- Loads Inter font from Google Fonts

### Styling

TailwindCSS v4 is configured via Vite plugin. The global CSS is in `app/app.css`.

### Vite Configuration

Key plugins in `vite.config.ts`:
1. `@cloudflare/vite-plugin` - Cloudflare SSR environment
2. `@tailwindcss/vite` - TailwindCSS v4 integration
3. `@react-router/dev/vite` - React Router build system
4. `vite-tsconfig-paths` - Path alias resolution (`~/*` -> `./app/*`)

### React Router Configuration

`react-router.config.ts`:
- SSR enabled
- Uses unstable Vite environment API

## Common Patterns

### Adding a New Route

1. Create route file in `app/routes/` (e.g., `app/routes/about.tsx`)
2. Add route to `app/routes.ts`:
   ```typescript
   import { route } from "@react-router/dev/routes";
   export default [
     index("routes/home.tsx"),
     route("about", "routes/about.tsx"),
   ] satisfies RouteConfig;
   ```
3. Run `bun run typecheck` to generate types

### Accessing Cloudflare Resources

Always access via `context.cloudflare.env` or `context.cloudflare.ctx` in loaders/actions:
```typescript
export function loader({ context }: Route.LoaderArgs) {
  const env = context.cloudflare.env;
  const ctx = context.cloudflare.ctx;
  // Use KV, D1, R2, etc. via env bindings
}
```

### Error Handling

Global errors are caught by the ErrorBoundary in `app/root.tsx`. It handles:
- 404 errors (via `isRouteErrorResponse`)
- Runtime errors (shows stack in dev mode)

## Development Notes

- **Package Manager**: This project uses Bun. Commands in README use `npm` but use `bun` for faster installs/scripts.
- **Type Generation**: Always run `bun run typecheck` after route changes to regenerate types.
- **Worker Types**: If you modify worker bindings, run `bun run cf-typegen` to update `worker-configuration.d.ts`.
- **Path Aliases**: Use `~/` to import from `app/` directory (configured in tsconfig and Vite).
